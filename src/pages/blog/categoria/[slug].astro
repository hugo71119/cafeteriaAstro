---
import PostCard from '@/components/blog/PostCard.astro'
import Layout from '@/layouts/Layout.astro'
import {CategoriesSlugSchema, CategorySchema, PostsSchema} from '@/types/index'

// 1ra consulta necesaria para el routing
export async function getStaticPaths() {
    const res = await fetch(`${import.meta.env.API_URL}/categories?_fields=slug`)
    const json = await res.json()
    const categories = CategoriesSlugSchema.parse(json)
    return categories.map(category => ({
        params: {slug: category.slug}
    }))
}


const { slug } = Astro.params
const catUrl = `${import.meta.env.API_URL}/categories?slug=${slug}`
const catRes = await fetch(catUrl)
const catJson = await catRes.json()
const category = CategorySchema.parse(catJson[0])



// Traer informacion de los post en base al slug obtenido previamiente
const postUrl = `${import.meta.env.API_URL}/posts?categories=${category.id}`
const postRes = await fetch(postUrl)
const postJson = await postRes.json()
const posts = PostsSchema.parse(postJson) 

---

<Layout
    title={`Posts de la Categoria: ${category.name}`}
    subtitle={`Posts de la Categoria: ${category.name}`}
    bgImage={posts[0].featured_images.full.url}
>
    {posts.map(post => <PostCard post={post} />)}
</Layout>
